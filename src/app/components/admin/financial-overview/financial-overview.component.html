<!-- financial-overview.component.html -->
<div class="financial-overview-container">
  <!-- Loading State -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Chargement des données financières...</p>
  </div>

  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title">
        <button class="btn-back" (click)="goBack()" title="Retour">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m15 18-6-6 6-6" />
          </svg>
        </button>
        <div class="title-content">
          <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23" />
              <path d="m17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
            </svg>
            Aperçu Financier Complet
            <span class="academic-year-badge">{{ academicYear }}</span>
          </h1>
          <p class="header-subtitle">Analyse complète des revenus et performances financières</p>
        </div>
      </div>
    </div>

    <div class="header-actions">
      <button class="btn-secondary" (click)="navigateToPaymentManagement()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <polyline points="14,2 14,8 20,8" />
        </svg>
        Gestion des Paiements
      </button>

      <button class="btn-secondary" (click)="refreshData()" [disabled]="isLoading">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
          <path d="M21 3v5h-5" />
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
          <path d="M3 21v-5h5" />
        </svg>
        Actualiser
      </button>

      <button class="btn-primary" (click)="printFinancialOverview()" [disabled]="isLoading">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6,9 6,2 18,2 18,9" />
          <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
          <rect x="6" y="14" width="12" height="8" />
        </svg>
        Imprimer
      </button>
    </div>
  </div>

  <!-- Simplified Filters Section -->
  <div class="filters-section" *ngIf="hasValidData()">
    <div class="filters-header">
      <h3>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46" />
        </svg>
        Filtres d'analyse
      </h3>
    </div>

    <form [formGroup]="filterForm" class="filters-form">
      <div class="filters-row">
        <div class="filter-group">
          <label for="gradeCategory">Catégorie de niveau</label>
          <select formControlName="gradeCategory" (change)="onGradeCategoryChange()">
            <option value="">Toutes les catégories</option>
            <option value="maternelle">Maternelle</option>
            <option value="primaire">Primaire</option>
            <option value="secondaire">Secondaire</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="grade">Niveau spécifique</label>
          <select formControlName="grade">
            <option value="">Tous les niveaux</option>
            <option *ngFor="let option of getGradeOptionsForCategory()" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label for="component">Composant</label>
          <select formControlName="component">
            <option value="all">Tous les composants</option>
            <option value="tuition">Frais scolaires</option>
            <option value="uniform">Uniforme</option>
            <option value="transportation">Transport</option>
            <option value="inscription">Frais d'inscription</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="paymentStatus">Statut de paiement</label>
          <select formControlName="paymentStatus">
            <option value="">Tous les statuts</option>
            <option value="pending">En attente</option>
            <option value="partial">Partiel</option>
            <option value="completed">Terminé</option>
            <option value="overdue">En retard</option>
          </select>
        </div>
      </div>

      <div class="filter-actions">
        <button type="button" class="btn-secondary btn-sm" (click)="clearFilters()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18" />
            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
          </svg>
          Effacer
        </button>

        <button type="button" class="btn-secondary btn-sm" (click)="refreshAnalytics()" [disabled]="isAnalyticsLoading">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
            <path d="M21 3v5h-5" />
          </svg>
          {{ isAnalyticsLoading ? 'Actualisation...' : 'Actualiser' }}
        </button>
      </div>
    </form>
  </div>

  <!-- Analytics Loading -->
  <div class="analytics-loading" *ngIf="isAnalyticsLoading">
    <div class="spinner-small"></div>
    <span>Mise à jour des analyses...</span>
  </div>

  <!-- Tab Navigation (Removed trends and reports) -->
  <div class="tab-navigation" *ngIf="hasValidData()">
    <button class="tab-button" [class.active]="activeTab === 'overview'">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 3v18h18" />
        <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3" />
      </svg>
      Income
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content" *ngIf="hasValidData()">

    <!-- Overview Tab -->
    <div class="tab-pane" *ngIf="activeTab === 'overview'">

      <!-- Quick Summary Cards -->
      <div class="summary-cards-grid compact">
        <div class="summary-card total-students compact" (click)="navigateToFilteredView({})">
          <div class="card-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
              <circle cx="9" cy="7" r="4" />
              <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
              <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </svg>
          </div>
          <div class="card-content">
            <h3 class="small">Total Étudiants</h3>
            <div class="card-value">{{ analytics?.overview?.totalStudents || dashboard?.overview?.totalStudents || 0 }}
            </div>
            <div class="card-subtitle small">Base d'analyse</div>
          </div>
        </div>

        <div class="summary-card collection-rate compact"
          [class]="getCollectionRateClass(analytics?.collectionRate?.percentage || dashboard?.overview?.collectionRate?.overall || '0')">
          <div class="card-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
            </svg>
          </div>
          <div class="card-content">
            <h3 class="small">Taux de Collecte</h3>
            <div class="card-value">{{ analytics?.collectionRate?.percentage ||
              dashboard?.overview?.collectionRate?.overall || '0' }}%</div>
            <div class="card-subtitle small">Performance globale</div>
          </div>
        </div>

        <div class="summary-card revenue-collected compact"
          (click)="navigateToFilteredView({ paymentStatus: 'completed' })">
          <div class="card-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v20m8-10a8 8 0 1 1-16 0 8 8 0 0 1 16 0z" />
            </svg>
          </div>
          <div class="card-content">
            <h3 class="small">Revenus Collectés</h3>
            <div class="card-value">{{ formatCurrency(analytics?.overview?.totalCollected ||
              dashboard?.overview?.totalRevenue?.grandTotal || 0) }}</div>
            <div class="card-subtitle small">Montant encaissé</div>
          </div>
        </div>

        <div class="summary-card revenue-outstanding" (click)="navigateToFilteredView({ paymentStatus: 'overdue' })">
          <div class="card-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <polyline points="12,6 12,12 16,14" />
            </svg>
          </div>
          <div class="card-content">
            <h3>Montant en Attente</h3>
            <div class="card-value">{{ formatCurrency(analytics?.overview?.totalOutstanding ||
              dashboard?.overview?.outstandingAmount?.grandTotal || 0) }}</div>
            <div class="card-subtitle">À collecter</div>
          </div>
        </div>
      </div>

      <!-- Component Analysis Grid -->
      <div class="component-analysis-section">
        <div class="section-header">
          <h2>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path
                d="M9 11H5a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h4m6-6h4a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-4m-6 0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2m-6 0V9a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" />
            </svg>
            Analyse par Composant
          </h2>
        </div>

        <div class="component-cards-grid compact">
          <!-- Tuition Component -->
          <div class="component-card tuition compact" (click)="navigateToComponent('tuition')">
            <div class="component-header compact">
              <div class="component-icon small">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 10v6M2 10l10-5 10 5-10 5z" />
                  <path d="M6 12v5c3 3 9 3 12 0v-5" />
                </svg>
              </div>
              <h3 class="compact">Frais Scolaires</h3>
            </div>
            <div class="component-metrics compact">
              <div class="metric-row small">
                <span class="metric-label">Attendu:</span>
                <span class="metric-value">{{ formatCurrency(getComponentAnalytics('tuition')?.expected || 0) }}</span>
              </div>
              <div class="metric-row small">
                <span class="metric-label">Collecté:</span>
                <span class="metric-value success">{{ formatCurrency(getComponentAnalytics('tuition')?.collected || 0)
                  }}</span>
              </div>
              <div class="metric-row small">
                <span class="metric-label">Étudiants:</span>
                <span class="metric-value">{{ getComponentAnalytics('tuition')?.studentsCount || 0 }}</span>
              </div>
            </div>
            <div class="component-progress compact">
              <div class="progress-bar small">
                <div class="progress-fill"
                  [style.width.%]="getComponentAnalytics('tuition')?.expected > 0 ?
                       (getComponentAnalytics('tuition')?.collected / getComponentAnalytics('tuition')?.expected) * 100 : 0">
                </div>
              </div>
              <span class="progress-text small">
                {{ getComponentAnalytics('tuition')?.expected > 0 ?
                roundNumber((getComponentAnalytics('tuition')?.collected / getComponentAnalytics('tuition')?.expected) *
                100) : 0 }}%
              </span>
            </div>
          </div>

          <!-- Uniform Component -->
          <div class="component-card uniform compact" (click)="navigateToComponent('uniform')">
            <div class="component-header compact">
              <div class="component-icon small">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 11c0-3.5 1.5-6.5 6-6.5s6 3 6 6.5" />
                  <path d="M12 2v20" />
                  <path d="M6 11v9a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-9" />
                </svg>
              </div>
              <h3 class="compact">Uniforme</h3>
            </div>
            <div class="component-metrics compact">
              <div class="metric-row small">
                <span class="metric-label">Attendu:</span>
                <span class="metric-value">{{ formatCurrency(getComponentAnalytics('uniform')?.expected || 0) }}</span>
              </div>
              <div class="metric-row small">
                <span class="metric-label">Collecté:</span>
                <span class="metric-value success">{{ formatCurrency(getComponentAnalytics('uniform')?.collected || 0)
                  }}</span>
              </div>
              <div class="metric-row small">
                <span class="metric-label">Étudiants:</span>
                <span class="metric-value">{{ getComponentAnalytics('uniform')?.studentsCount || 0 }}</span>
              </div>
            </div>
            <div class="component-progress compact">
              <div class="progress-bar small">
                <div class="progress-fill"
                  [style.width.%]="getComponentAnalytics('uniform')?.expected > 0 ?
                       (getComponentAnalytics('uniform')?.collected / getComponentAnalytics('uniform')?.expected) * 100 : 0">
                </div>
              </div>
              <span class="progress-text small">
                {{ getComponentAnalytics('uniform')?.expected > 0 ?
                roundNumber((getComponentAnalytics('uniform')?.collected / getComponentAnalytics('uniform')?.expected) *
                100) : 0 }}%
              </span>
            </div>
          </div>

          <!-- Transportation Component -->
          <div class="component-card transportation compact" (click)="navigateToComponent('transportation')">
            <div class="component-header compact">
              <div class="component-icon small">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 6v6h8V6" />
                  <path d="M4 12h16l2 6H2l2-6z" />
                  <circle cx="8" cy="19" r="2" />
                  <circle cx="16" cy="19" r="2" />
                </svg>
              </div>
              <h3 class="compact">Transport</h3>
            </div>
            <div class="component-metrics compact">
              <div class="metric-row small">
                <span class="metric-label">Attendu:</span>
                <span class="metric-value">{{ formatCurrency(getComponentAnalytics('transportation')?.expected || 0)
                  }}</span>
              </div>
              <div class="metric-row small">
                <span class="metric-label">Collecté:</span>
                <span class="metric-value success">{{ formatCurrency(getComponentAnalytics('transportation')?.collected
                  || 0) }}</span>
              </div>
              <div class="metric-row small">
                <span class="metric-label">Étudiants:</span>
                <span class="metric-value">{{ getComponentAnalytics('transportation')?.studentsCount || 0 }}</span>
              </div>
            </div>
            <div class="component-progress compact">
              <div class="progress-bar small">
                <div class="progress-fill"
                  [style.width.%]="getComponentAnalytics('transportation')?.expected > 0 ?
                       (getComponentAnalytics('transportation')?.collected / getComponentAnalytics('transportation')?.expected) * 100 : 0">
                </div>
              </div>
              <span class="progress-text small">
                {{ getComponentAnalytics('transportation')?.expected > 0 ?
                roundNumber((getComponentAnalytics('transportation')?.collected /
                getComponentAnalytics('transportation')?.expected) * 100) : 0 }}%
              </span>
            </div>
          </div>

          <!-- Inscription Component -->
          <div class="component-card inscription compact" (click)="navigateToComponent('inscription')">
            <div class="component-header compact">
              <div class="component-icon small">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                  <polyline points="14,2 14,8 20,8" />
                  <line x1="16" y1="13" x2="8" y2="13" />
                  <line x1="16" y1="17" x2="8" y2="17" />
                </svg>
              </div>
              <h3 class="compact">Frais d'Inscription</h3>
            </div>
            <div class="component-metrics compact">
              <div class="metric-row small">
                <span class="metric-label">Attendu:</span>
                <span class="metric-value">{{ formatCurrency(getComponentAnalytics('inscription')?.expected || 0)
                  }}</span>
              </div>
              <div class="metric-row small">
                <span class="metric-label">Collecté:</span>
                <span class="metric-value success">{{ formatCurrency(getComponentAnalytics('inscription')?.collected ||
                  0) }}</span>
              </div>
              <div class="metric-row small">
                <span class="metric-label">Étudiants:</span>
                <span class="metric-value">{{ getComponentAnalytics('inscription')?.studentsCount || 0 }}</span>
              </div>
            </div>
            <div class="component-progress compact">
              <div class="progress-bar small">
                <div class="progress-fill"
                  [style.width.%]="getComponentAnalytics('inscription')?.expected > 0 ?
                       (getComponentAnalytics('inscription')?.collected / getComponentAnalytics('inscription')?.expected) * 100 : 0">
                </div>
              </div>
              <span class="progress-text small">
                {{ getComponentAnalytics('inscription')?.expected > 0 ?
                roundNumber((getComponentAnalytics('inscription')?.collected /
                getComponentAnalytics('inscription')?.expected) * 100) : 0 }}%
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="!isLoading && !hasValidData()">
    <div class="error-content">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#F44336" stroke-width="2">
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="12" />
        <line x1="12" y1="16" x2="12.01" y2="16" />
      </svg>

      <h3>Aucune donnée disponible</h3>
      <p>Impossible de charger les données financières pour l'année académique sélectionnée.</p>

      <button class="btn-primary" (click)="refreshData()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
          <path d="M21 3v5h-5" />
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
          <path d="M3 21v-5h5" />
        </svg>
        Réessayer
      </button>
    </div>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="!isLoading && !hasValidData()">
    <div class="error-content">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#F44336" stroke-width="2">
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="12" />
        <line x1="12" y1="16" x2="12.01" y2="16" />
      </svg>

      <h3>Aucune donnée disponible</h3>
      <p>Impossible de charger les données financières pour l'année académique sélectionnée.</p>

      <button class="btn-primary" (click)="refreshData()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
          <path d="M21 3v5h-5" />
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
          <path d="M3 21v-5h5" />
        </svg>
        Réessayer
      </button>
    </div>
  </div>
</div>



<!-- Report Summary -->
<div class="report-summary-section" *ngIf="financialSummary" style="margin-bottom: 3rem;">
  <div class="section-header">
    <h3>Résumé Financier</h3>
  </div>

  <div class="summary-metrics compact">
    <div class="summary-metric total compact">
      <h4 class="small">Total</h4>
      <div class="metric-value">{{ formatCurrency(financialSummary?.financial?.revenue?.total || 0) }}</div>
      <div class="metric-subtitle small">Revenus collectés</div>
    </div>

    <div class="summary-metric expected compact">
      <h4 class="small">Attendu</h4>
      <div class="metric-value">{{ formatCurrency(financialSummary?.financial?.expected?.total || 0) }}</div>
      <div class="metric-subtitle small">Revenus prévus</div>
    </div>

    <div class="summary-metric outstanding compact">
      <h4 class="small">En Attente</h4>
      <div class="metric-value">{{ formatCurrency(financialSummary?.financial?.outstanding?.total || 0) }}</div>
      <div class="metric-subtitle small">À collecter</div>
    </div>

    <div class="summary-metric rate compact">
      <h4 class="small">Taux Global</h4>
      <div class="metric-value"
        [class]="getCollectionRateClass(financialSummary?.financial?.collectionRate?.overall || '0')">
        {{ financialSummary?.financial?.collectionRate?.overall || '0%' }}
      </div>
      <div class="metric-subtitle small">Collecte</div>
    </div>
  </div>

  <div class="component-summary">
    <h4>Détail par Composant</h4>
    <div class="component-summary-grid">
      <div class="component-summary-item tuition">
        <span class="component-label">Scolarité</span>
        <span class="component-rate">{{ financialSummary?.financial?.collectionRate?.tuition || '0%' }}</span>
        <span class="component-amount">{{ formatCurrency(financialSummary?.financial?.revenue?.tuition || 0) }}</span>
      </div>
      <div class="component-summary-item uniform">
        <span class="component-label">Uniforme</span>
        <span class="component-rate">{{ financialSummary?.financial?.collectionRate?.uniform || '0%' }}</span>
        <span class="component-amount">{{ formatCurrency(financialSummary?.financial?.revenue?.uniform || 0) }}</span>
      </div>
      <div class="component-summary-item transportation">
        <span class="component-label">Transport</span>
        <span class="component-rate">{{ financialSummary?.financial?.collectionRate?.transportation || '0%' }}</span>
        <span class="component-amount">{{ formatCurrency(financialSummary?.financial?.revenue?.transportation || 0)
          }}</span>
      </div>
      <div class="component-summary-item inscription">
        <span class="component-label">Inscription</span>
        <span class="component-rate">{{ financialSummary?.financial?.collectionRate?.inscription || '0%' }}</span>
        <span class="component-amount">{{ formatCurrency(financialSummary?.financial?.revenue?.inscription || 0)
          }}</span>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="!isLoading && !hasValidData()">
    <div class="error-content">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#F44336" stroke-width="2">
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="12" />
        <line x1="12" y1="16" x2="12.01" y2="16" />
      </svg>

      <h3>Aucune donnée disponible</h3>
      <p>Impossible de charger les données financières pour l'année académique sélectionnée.</p>

      <button class="btn-primary" (click)="refreshData()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
          <path d="M21 3v5h-5" />
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
          <path d="M3 21v-5h5" />
        </svg>
        Réessayer
      </button>
    </div>
  </div>
</div>
<div class="analytics-content">

  <!-- Charts Section -->
  <div class="charts-section">
    <div class="section-header">
      <h2>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
          <rect x="7" y="7" width="3" height="9" />
          <rect x="14" y="7" width="3" height="5" />
        </svg>
        Graphiques d'Analyse
      </h2>
    </div>

    <div class="charts-grid compact">
      <!-- Collection Rate Chart -->
      <div class="chart-card compact">
        <h4 class="chart-title small">Taux de Collecte Global</h4>
        <div class="chart-placeholder compact">
          <div class="chart-info" *ngIf="getChartData('collectionRate')">
            <div class="chart-metric collected small">
              <span class="label">Collecté</span>
              <span class="value">{{ analytics?.collectionRate?.percentage || '0' }}%</span>
            </div>
            <div class="chart-metric outstanding small">
              <span class="label">En attente</span>
              <span class="value">{{ getRemainingCollectionPercentage() }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Component Breakdown Chart -->
      <div class="chart-card compact">
        <h4 class="chart-title small">Répartition par Composant</h4>
        <div class="chart-placeholder compact">
          <div class="components-chart" *ngIf="analytics">
            <div class="component-bar tuition">
              <span class="component-label">Scolarité</span>
              <div class="bar-container">
                <div class="bar-fill" [style.width.%]="getComponentProgressWidth('tuition')">
                </div>
              </div>
              <span class="component-value">{{ formatCurrency(analytics?.byComponent?.tuition?.collected || 0)
                }}</span>
            </div>
            <div class="component-bar uniform">
              <span class="component-label">Uniforme</span>
              <div class="bar-container">
                <div class="bar-fill" [style.width.%]="getComponentProgressWidth('uniform')">
                </div>
              </div>
              <span class="component-value">{{ formatCurrency(analytics?.byComponent?.uniform?.collected || 0)
                }}</span>
            </div>
            <div class="component-bar transportation">
              <span class="component-label">Transport</span>
              <div class="bar-container">
                <div class="bar-fill" [style.width.%]="getComponentProgressWidth('transportation')">
                </div>
              </div>
              <span class="component-value">{{ formatCurrency(analytics?.byComponent?.transportation?.collected ||
                0) }}</span>
            </div>
            <div class="component-bar inscription">
              <span class="component-label">Inscription</span>
              <div class="bar-container">
                <div class="bar-fill" [style.width.%]="getComponentProgressWidth('inscription')">
                </div>
              </div>
              <span class="component-value">{{ formatCurrency(analytics?.byComponent?.inscription?.collected || 0)
                }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Grade Category Performance -->
      <div class="chart-card compact">
        <h4 class="chart-title small">Performance par Catégorie</h4>
        <div class="chart-placeholder compact">
          <div class="grade-chart" *ngIf="analytics">
            <div class="grade-bar maternelle compact">
              <span class="grade-label small">Maternelle</span>
              <div class="bar-container small">
                <div class="bar-expected"></div>
                <div class="bar-collected" [style.width.%]="getGradeCategoryProgressWidth('maternelle')">
                </div>
              </div>
              <span class="grade-value small">{{ analytics?.byGradeCategory?.maternelle?.collectionRate || '0%'
                }}</span>
            </div>
            <div class="grade-bar primaire compact">
              <span class="grade-label small">Primaire</span>
              <div class="bar-container small">
                <div class="bar-expected"></div>
                <div class="bar-collected" [style.width.%]="getGradeCategoryProgressWidth('primaire')">
                </div>
              </div>
              <span class="grade-value small">{{ analytics?.byGradeCategory?.primaire?.collectionRate || '0%' }}</span>
            </div>
            <div class="grade-bar secondaire compact">
              <span class="grade-label small">Secondaire</span>
              <div class="bar-container small">
                <div class="bar-expected"></div>
                <div class="bar-collected" [style.width.%]="getGradeCategoryProgressWidth('secondaire')">
                </div>
              </div>
              <span class="grade-value small">{{ analytics?.byGradeCategory?.secondaire?.collectionRate || '0%'
                }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Analytics Tables -->
  <div class="analytics-tables compact">
    <div class="section-header small">
      <h2>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18" />
          <path d="M3 12h18" />
          <path d="M3 18h18" />
        </svg>
        Analyse Détaillée
      </h2>
    </div>

    <!-- Grade Level Breakdown -->
    <div class="analytics-table-card compact">
      <h4 class="small">Analyse par Niveau</h4>
      <div class="table-responsive compact">
        <table class="analytics-table compact">
          <thead>
            <tr>
              <th class="small">Niveau</th>
              <th class="small">Étudiants</th>
              <th class="small">Attendu</th>
              <th class="small">Collecté</th>
              <th class="small">En Attente</th>
              <th class="small">Taux</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let grade of analytics?.byGrade | keyvalue">
              <td class="small">{{ getGradeLabel(grade.key) }}</td>
              <td class="small">{{ grade.value.count }}</td>
              <td class="small">{{ formatCurrency(grade.value.expected) }}</td>
              <td class="success small">{{ formatCurrency(grade.value.collected) }}</td>
              <td class="warning small">{{ formatCurrency(grade.value.outstanding) }}</td>
              <td class="small">
                <span class="badge small" [class]="getCollectionRateClass(grade.value.collectionRate)">
                  {{ grade.value.collectionRate }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- Enhanced Report Preview -->
<div class="report-preview-section compact" *ngIf="hasEnhancedReportData()" style="margin-top: 2rem;">
  <div class="section-header small">
    <h3 class="small">Aperçu du Rapport Détaillé</h3>
    <p class="section-subtitle small">{{ enhancedReport?.report?.totalRecords || 0 }} enregistrements trouvés</p>
  </div>

  <div class="report-filters-summary compact" *ngIf="hasActiveFilters()">
    <h4 class="small">Filtres Appliqués:</h4>
    <div class="filter-tags compact">
      <span class="filter-tag" *ngIf="filterForm.value.gradeCategory">
        Catégorie: {{ getGradeCategoryLabel(filterForm.value.gradeCategory) }}
      </span>
      <span class="filter-tag" *ngIf="filterForm.value.grade">
        Niveau: {{ getGradeLabel(filterForm.value.grade) }}
      </span>
      <span class="filter-tag" *ngIf="filterForm.value.component && filterForm.value.component !== 'all'">
        Composant: {{ getComponentLabel(filterForm.value.component) }}
      </span>
      <span class="filter-tag" *ngIf="filterForm.value.paymentStatus">
        Statut: {{ getPaymentStatusLabel(filterForm.value.paymentStatus) }}
      </span>
    </div>
  </div>

  <div class="report-table-preview">
    <table class="report-table">
      <thead>
        <tr>
          <th>Étudiant</th>
          <th>Niveau</th>
          <th>Attendu</th>
          <th>Payé</th>
          <th>Restant</th>
          <th>Statut</th>
          <th>Remise</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of enhancedReport?.report?.data?.slice(0, 10)">
          <td>
            <div class="student-info">
              <span class="student-name">{{ row.student.name }}</span>
              <span class="student-email">{{ row.student.email }}</span>
            </div>
          </td>
          <td>{{ getGradeLabel(row.student.grade || '') }}</td>
          <td>{{ formatCurrency(row.amounts.expected) }}</td>
          <td class="success">{{ formatCurrency(row.amounts.paid) }}</td>
          <td class="warning">{{ formatCurrency(row.amounts.outstanding) }}</td>
          <td>
            <span class="badge" [class]="row.status">{{ getStatusLabel(row.status) }}</span>
          </td>
          <td>
            <span *ngIf="row.discount" class="discount-info">
              {{ row.discount.percentage }}%
            </span>
            <span *ngIf="!row.discount" class="no-discount">Aucune</span>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="table-footer" *ngIf="(enhancedReport?.report?.totalRecords || 0) > 10">
      <p>Affichage de 10 sur {{ enhancedReport?.report?.totalRecords || 0 }} enregistrements.</p>
    </div>
  </div>
</div>

<!-- Error State -->
<div class="error-state" *ngIf="!hasValidData() && !isLoading">
  <div class="error-content">
    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
      <line x1="12" y1="9" x2="12" y2="13" />
      <line x1="12" y1="17" x2="12.01" y2="17" />
    </svg>
    <h3>Erreur de chargement</h3>
    <p>Impossible de charger les données financières. Veuillez réessayer.</p>
    <div class="error-actions">
      <button class="btn-primary" (click)="refreshData()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
          <path d="M21 3v5h-5" />
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
          <path d="M3 21v-5h5" />
        </svg>
        Réessayer
      </button>
    </div>
  </div>
</div>